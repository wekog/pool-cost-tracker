services:
  api:
    build:
      context: .
      dockerfile: api/Dockerfile
    environment:
      - PAPERLESS_BASE_URL
      - PAPERLESS_TOKEN
      - POOL_TAG_NAME
      - SYNC_PAGE_SIZE
      - SYNC_LOOKBACK_DAYS
      - DATABASE_URL
      - SCHEDULER_ENABLED
      - SCHEDULER_INTERVAL_MINUTES
      - SCHEDULER_RUN_ON_STARTUP
    volumes:
      - ./data:/data
    ports:
      - "18000:8000"

  ui:
    build:
      context: .
      dockerfile: ui/Dockerfile
    depends_on:
      - api
    environment:
      - API_BASE_URL=http://api:8000

  ui_proxy:
    image: nginx:alpine
    depends_on:
      - ui
    ports:
      - "8501:8501"
    command:
      - /bin/sh
      - -lc
      - |
          printf '%s\n' \
            'server {' \
            '  listen 8501;' \
            '' \
            '  large_client_header_buffers 4 16k;' \
            '' \
            '  location / {' \
            '    proxy_pass http://ui:8501;' \
            '    proxy_http_version 1.1;' \
            '' \
            '    proxy_set_header Host $$host;' \
            '    proxy_set_header X-Real-IP $$remote_addr;' \
            '    proxy_set_header X-Forwarded-For $$proxy_add_x_forwarded_for;' \
            '    proxy_set_header X-Forwarded-Proto $$scheme;' \
            '' \
            '    proxy_set_header Upgrade $$http_upgrade;' \
            '    proxy_set_header Connection "upgrade";' \
            '' \
            '    proxy_read_timeout 3600;' \
            '    proxy_send_timeout 3600;' \
            '' \
            '    proxy_buffering off;' \
            '    proxy_request_buffering off;' \
            '' \
            '    gzip off;' \
            '  }' \
            '}' \
            > /etc/nginx/conf.d/default.conf
          exec nginx -g 'daemon off;'
